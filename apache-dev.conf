# Apache конфигурация для разработки (dev режим)
# Frontend: npm run dev (порт 5173)
# Backend: npm start (порт 3001)

<VirtualHost *:80>
    ServerName portfolio.hyzmat-tm.com
    ServerAlias localhost

    # Логи
    ErrorLog ${APACHE_LOG_DIR}/portfolio_error.log
    CustomLog ${APACHE_LOG_DIR}/portfolio_access.log combined

    # Включить модули прокси
    # sudo a2enmod proxy proxy_http proxy_wstunnel rewrite headers ssl

    # Проксирование API запросов на backend
    ProxyPass /api http://localhost:3001/api
    ProxyPassReverse /api http://localhost:3001/api

    # WebSocket для Vite HMR должен быть ДО основного ProxyPass
    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} =websocket [NC]
    RewriteRule /(.*) ws://localhost:5173/$1 [P,L]
    RewriteCond %{HTTP:Upgrade} !=websocket [NC]
    RewriteRule /(.*) http://localhost:5173/$1 [P,L]

    # Заголовки для правильной работы
    ProxyPreserveHost On
    RequestHeader set X-Forwarded-Proto "http"
    RequestHeader set X-Forwarded-Port "80"

    # Таймауты
    ProxyTimeout 300
</VirtualHost>

# HTTPS Virtual Host для WebSocket (если используется SSL)
<VirtualHost *:443>
    ServerName portfolio.hyzmat-tm.com

    # Если есть SSL сертификаты, раскомментируйте:
    # SSLEngine on
    # SSLCertificateFile /etc/ssl/certs/portfolio.crt
    # SSLCertificateKeyFile /etc/ssl/private/portfolio.key

    # Логи
    ErrorLog ${APACHE_LOG_DIR}/portfolio_error_ssl.log
    CustomLog ${APACHE_LOG_DIR}/portfolio_access_ssl.log combined

    # Проксирование API запросов на backend
    ProxyPass /api http://localhost:3001/api
    ProxyPassReverse /api http://localhost:3001/api

    # WebSocket для Vite HMR (wss://)
    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} =websocket [NC]
    RewriteRule /(.*) ws://localhost:5173/$1 [P,L]
    RewriteCond %{HTTP:Upgrade} !=websocket [NC]
    RewriteRule /(.*) http://localhost:5173/$1 [P,L]

    # Заголовки
    ProxyPreserveHost On
    RequestHeader set X-Forwarded-Proto "https"
    RequestHeader set X-Forwarded-Port "443"

    # Таймауты
    ProxyTimeout 300
</VirtualHost>
